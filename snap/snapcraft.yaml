name: imx-kernel
summary: The Ubuntu iMX Linux kernel
description: This Ubuntu Linux kernel for NXP iMX family of devices

grade: stable
confinement: strict
type: kernel
build-base: core20
adopt-info: kernel

architectures:
  - build-on: [amd64, arm64]
    run-on: arm64


parts:
    kernel:
        plugin: x-kernel
        source: .
        kdefconfig: [ "s32gen1_emu_snappy_defconfig" ]
        kernel-with-firmware: false
        kernel-image-target:
            arm64: Image
        kernel-initrd-flavour: edge
        kernel-initrd-compression: gz
        override-build: |
            snapcraftctl build
            kernel_version=$(make kernelversion)
            snapcraftctl set-version $(git describe --tags | cut -c 19-42)
            mkdir -p ${SNAPCRAFT_PART_INSTALL}/firmware
        organize:
            kernel.img: Image
        prime:
            - -initrd.img*
            - -Image*
            - -dtbs

    test-keys:
        plugin: dump
        source: https://git.launchpad.net/~ondrak/+git/dev-keys
        source-type: git
        source-branch: master
        organize:
            '*': signing-key/
        prime:
            - -*

    fit-image:
        after:
            - kernel
            - test-keys
        plugin: nil
        override-build: |
            cp ${SNAPCRAFT_PROJECT_DIR}/kernel_*.its ${SNAPCRAFT_STAGE}
            # include key dir in case there are keys available
            mkimage \
                -f ${SNAPCRAFT_STAGE}/kernel_${SNAPCRAFT_TARGET_ARCH}.its \
                -r ${SNAPCRAFT_PART_INSTALL}/kernel.img \
                -k ${SNAPCRAFT_STAGE}/signing-key

build-packages:
    - dpkg-dev
    - u-boot-tools
    - libssl-dev
    - libfdt-dev
    - flex
    - bison
    - initramfs-tools-core
