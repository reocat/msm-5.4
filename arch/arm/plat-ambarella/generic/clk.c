/*
 * arch/arm/plat-ambarella/generic/clk.c
 *
 * Author: Anthony Ginger <hfjiang@ambarella.com>
 *
 * Copyright (C) 2004-2010, Ambarella, Inc.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
 */

#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/list.h>
#include <linux/errno.h>
#include <linux/err.h>
#include <linux/platform_device.h>
#include <linux/delay.h>
#include <linux/spinlock.h>
#include <linux/io.h>
#include <linux/export.h>
#include <linux/proc_fs.h>
#include <linux/seq_file.h>
#include <linux/clk.h>

#include <asm/uaccess.h>

#include <mach/hardware.h>
#include <plat/clk.h>

/* ==========================================================================*/
static LIST_HEAD(ambarella_all_clocks);
DEFINE_SPINLOCK(ambarella_clock_lock);

/* ==========================================================================*/
static unsigned int ambarella_clk_ref_freq = REF_CLK_FREQ;

const struct pll_table_s ambarella_rct_pll_table[AMBARELLA_RCT_PLL_TABLE_SIZE] =
{
	{	 16601562500000,   0,  0,  5, 10},// 0.392157
	{	 16732282936573,   0,  0,  5, 10},// 0.392154
	{	 16865080222486,   0,  0,  5, 10},// 1.176476
	{	 17000000923872,   0,  0,  5, 10},// 1.960790
	{	 17137097194791,   0,  0,  5, 10},// 2.745100
	{	 17276423051953,   0,  0,  5, 10},// 3.529413
	{	 17418032512068,   0,  0,  5, 10},// 4.313724
	{	 17561983317137,   1,  0, 10, 10},// 3.529413
	{	 17708333209157,   1,  0, 10, 10},// 2.673798
	{	 17847768962383,   1,  0, 10, 10},// 1.871658
	{	 17989417538047,   1,  0, 10, 10},// 1.069521
	{	 18133332952857,   1,  0, 10, 10},// 0.267382
	{	 18279569223523,   1,  0, 10, 10},// 0.534756
	{	 18428184092045,   1,  0, 10, 10},// 1.336897
	{	 18579235300422,   2,  0, 15, 10},// 0.919116
	{	 18732782453299,   2,  0, 15, 10},// 0.091911
	{	 18973214551806,   2,  0, 15, 10},// 1.176472
	{	 19122609868646,   2,  0, 15, 10},// 1.948530
	{	 19274376332760,   2,  0, 15, 10},// 2.720588
	{	 19428571686149,   0,  0,  4, 10},// 2.941175
	{	 19585253670812,   0,  0,  4, 10},// 2.117646
	{	 19744483754039,   0,  0,  4, 10},// 1.294115
	{	 19906323403120,   0,  0,  4, 10},// 0.470587
	{	 20070837810636,   0,  0,  4, 10},// 0.352939
	{	 20238095894456,   0,  0,  4, 10},// 1.176474
	{	 20432692021132,   0,  0,  4, 10},// 2.117646
	{	 20593579858541,   0,  0,  4, 10},// 2.882354
	{	 20757021382451,   2,  0, 13, 10},// 3.235291
	{	 20923076197505,   2,  0, 13, 10},// 2.415970
	{	 21091811358929,   2,  0, 13, 10},// 1.596639
	{	 21263290196657,   2,  0, 13, 10},// 0.777308
	{	 21437577903271,   2,  0, 13, 10},// 0.042013
	{	 21614748984575,   2,  0, 13, 10},// 0.861345
	{	 21794872358441,   2,  0, 13, 10},// 1.680675
	{	 22135416045785,   1,  0,  8, 10},// 0.392160
	{	 22309711202979,   1,  0,  8, 10},// 0.392156
	{	 22486772388220,   1,  0,  8, 10},// 1.176470
	{	 22666666656733,   2,  0, 12, 10},// 1.809955
	{	 22849462926388,   2,  0, 12, 10},// 0.995473
	{	 23035230115056,   2,  0, 12, 10},// 0.180997
	{	 23224044591188,   2,  0, 12, 10},// 0.633488
	{	 23415977135301,   2,  0, 12, 10},// 1.447960
	{	 23611111566424,   2,  0, 12, 10},// 2.262445
	{	 23809524253011,   2,  0, 12, 10},// 3.076925
	{	 24147726595402,   0,  0,  3, 10},// 3.529415
	{	 24337867274880,   0,  0,  3, 10},// 2.720586
	{	 24531025439501,   0,  0,  3, 10},// 1.911761
	{	 24727271869779,   0,  0,  3, 10},// 1.102945
	{	 24926686659455,   0,  0,  3, 10},// 0.294116
	{	 25129342451692,   0,  0,  3, 10},// 0.514707
	{	 25335321202874,   0,  0,  3, 10},// 1.323532
	{	 25544703006744,   0,  0,  3, 10},// 2.132352
	{	 25757575407624,   0,  0,  3, 10},// 2.941175
	{	 25974025949836,   3,  0, 14, 10},// 2.666667
	{	 26194144040346,   3,  0, 14, 10},// 1.803925
	{	 26562500745058,   3,  0, 14, 10},// 0.392154
	{	 26771653443575,   3,  0, 14, 10},// 0.392156
	{	 26984127238393,   2,  0, 10, 10},// 1.069518
	{	 27200000360608,   2,  0, 10, 10},// 0.267378
	{	 27419354766607,   2,  0, 10, 10},// 0.534759
	{	 27642276138067,   2,  0, 10, 10},// 1.336897
	{	 27868852019310,   2,  0, 10, 10},// 2.139036
	{	 28099173679948,   1,  0,  6, 10},// 1.680672
	{	 28333334252238,   1,  0,  6, 10},// 0.840333
	{	 28571428731084,   1,  0,  6, 10},// 0.000001
	{	 28813559561968,   1,  0,  6, 10},// 0.840337
	{	 29059829190373,   1,  0,  6, 10},// 1.680673
	{	 29513888061047,   2,  0,  9, 10},// 1.647062
	{	 29746280983090,   2,  0,  9, 10},// 0.852944
	{	 29982363805175,   2,  0,  9, 10},// 0.058822
	{	 30222222208977,   2,  0,  9, 10},// 0.735294
	{	 30465949326754,   3,  0, 12, 10},// 0.995477
	{	 30713640153408,   3,  0, 12, 10},// 0.180997
	{	 30965391546488,   3,  0, 12, 10},// 0.633484
	{	 31221304088831,   4,  0, 15, 10},// 0.091911
	{	 31481482088566,   4,  0, 15, 10},// 0.735296
	{	 31746033579111,   4,  0, 15, 10},// 1.562506
	{	 32015066593885,   4,  0, 15, 10},// 2.389708
	{	 32288700342177,   4,  0, 15, 10},// 3.216916
	{	 32567050307989,   0,  0,  2, 10},// 2.352940
	{	 32850243151188,   0,  0,  2, 10},// 1.470583
	{	 33203125000000,   0,  0,  2, 10},// 0.392157
	{	 33464565873146,   0,  0,  2, 10},// 0.392154
	{	 33730160444975,   0,  0,  2, 10},// 1.176476
	{	 34000001847744,   0,  0,  2, 10},// 1.960790
	{	 34274194389582,   0,  0,  2, 10},// 2.745100
	{	 34552846103907,   4,  0, 13, 10},// 3.361343
	{	 34836065024136,   4,  0, 13, 10},// 2.521010
	{	 35123966634274,   4,  0, 13, 10},// 1.680673
	{	 35416666418314,   4,  0, 13, 10},// 0.840337
	{	 35714287310839,   4,  0, 13, 10},// 0.000004
	{	 36016948521137,   4,  0, 13, 10},// 0.840334
	{	 36324787884951,   3,  0, 10, 10},// 0.106948
	{	 36637932062149,   3,  0, 10, 10},// 0.748666
	{	 36956522613764,   2,  0,  7, 10},// 1.470586
	{	 37280701100826,   2,  0,  7, 10},// 0.588237
	{	 37610620260239,   2,  0,  7, 10},// 0.294120
	{	 37946429103613,   2,  0,  7, 10},// 1.176472
	{	 38245219737291,   4,  0, 12, 10},// 0.565610
	{	 38548752665520,   4,  0, 12, 10},// 0.226244
	{	 38857143372297,   4,  0, 12, 10},// 1.018101
	{	 39170507341623,   4,  0, 12, 10},// 1.809956
	{	 39488967508078,   1,  0,  4, 10},// 1.294115
	{	 39812646806240,   1,  0,  4, 10},// 0.470587
	{	 40141675621271,   1,  0,  4, 10},// 0.352939
	{	 40476191788912,   1,  0,  4, 10},// 1.176474
	{	 40816325694323,   1,  0,  4, 10},// 1.999998
	{	 41162226349115,   4,  0, 11, 10},// 1.225493
	{	 41514042764902,   4,  0, 11, 10},// 0.367644
	{	 41871920228004,   4,  0, 11, 10},// 0.490194
	{	 42236026376486,   4,  0, 11, 10},// 1.348043
	{	 42606517672539,   2,  0,  6, 10},// 0.588232
	{	 42983565479517,   2,  0,  6, 10},// 0.294119
	{	 43367348611355,   6,  0, 15, 10},// 0.882349
	{	 43758042156696,   6,  0, 15, 10},// 0.018379
	{	 44270832091570,   3,  0,  8, 10},// 0.392160
	{	 44619422405958,   3,  0,  8, 10},// 0.392156
	{	 44973544776440,   4,  0, 10, 10},// 1.069519
	{	 45333333313465,   4,  0, 10, 10},// 0.267380
	{	 45698925852776,   4,  0, 10, 10},// 0.534762
	{	 46070460230112,   5,  0, 12, 10},// 0.180997
	{	 46448089182377,   6,  0, 14, 10},// 0.470584
	{	 46831954270601,   6,  0, 14, 10},// 0.352938
	{	 47222223132849,   6,  0, 14, 10},// 1.176472
	{	 47619048506021,   6,  0, 14, 10},// 2.000002
	{	 48022598028183,   6,  0, 14, 10},// 2.823528
	{	 48433046787977,   0,  0,  1, 10},// 3.235298
	{	 48850573599339,   0,  0,  1, 10},// 2.352944
	{	 49275361001492,   0,  0,  1, 10},// 1.470591
	{	 49707602709532,   0,  0,  1, 10},// 0.588235
	{	 50147492438555,   0,  0,  1, 10},// 0.294117
	{	 50595238804817,   0,  0,  1, 10},// 1.176472
	{	 51051050424576,   0,  0,  1, 10},// 2.058822
	{	 51515150815248,   0,  0,  1, 10},// 2.941175
	{	 51987767219543,   7,  0, 14, 10},// 2.588236
	{	 52469134330750,   7,  0, 14, 10},// 1.647062
	{	 53125001490116,   7,  0, 14, 10},// 0.392154
	{	 53543306887150,   7,  0, 14, 10},// 0.392156
	{	 53968254476786,   6,  0, 12, 10},// 0.226245
	{	 54400000721216,   5,  0, 10, 10},// 0.267378
	{	 54838709533215,   5,  0, 10, 10},// 0.534759
	{	 55284552276134,   4,  0,  8, 10},// 0.490197
	{	 55737704038620,   4,  0,  8, 10},// 0.326796
	{	 56198347359896,   8,  0, 15, 10},// 0.091911
	{	 56666668504477,   8,  0, 15, 10},// 0.735297
	{	 57142857462168,   3,  0,  6, 10},// 0.000001
	{	 57627119123936,   3,  0,  6, 10},// 0.840337
	{	 58119658380747,   6,  0, 11, 10},// 0.367647
	{	 58620691299438,   6,  0, 11, 10},// 0.490199
	{	 59130433946848,   6,  0, 11, 10},// 1.348038
	{	 59649121016264,   2,  0,  4, 10},// 0.588238
	{	 60176990926266,   2,  0,  4, 10},// 0.294117
	{	 60714285820723,   2,  0,  4, 10},// 1.176471
	{	 61261262744665,   7,  0, 12, 10},// 0.452486
	{	 61818182468414,   7,  0, 12, 10},// 0.452490
	{	 62385320663452,   4,  0,  7, 10},// 0.183824
	{	 62962964177132,   4,  0,  7, 10},// 0.735296
	{	 63551403582096,   6,  0, 10, 10},// 0.133687
	{	 64150944352150,   8,  0, 13, 10},// 0.210083
	{	 64761906862258,   8,  0, 13, 10},// 0.735297
	{	 65384618937969,   8,  0, 13, 10},// 1.680678
	{	 65891474485397,   1,  0,  2, 10},// 1.176468
	{	 66406250000000,   1,  0,  2, 10},// 0.392157
	{	 66929131746292,   1,  0,  2, 10},// 0.392154
	{	 67460320889950,   1,  0,  2, 10},// 1.176476
	{	 68000003695488,  10,  0, 15, 10},// 1.102936
	{	 68548388779163,  10,  0, 15, 10},// 0.294115
	{	 69105692207813,   8,  0, 12, 10},// 0.180994
	{	 69672130048274,   6,  0,  9, 10},// 0.470590
	{	 70247933268547,   6,  0,  9, 10},// 0.352940
	{	 70833332836628,   4,  0,  6, 10},// 0.840337
	{	 71428574621677,   4,  0,  6, 10},// 0.000004
	{	 72033897042274,   4,  0,  6, 10},// 0.840334
	{	 72649575769901,   7,  0, 10, 10},// 0.106948
	{	 73275864124298,  10,  0, 14, 10},// 0.078429
	{	 73913045227528,  10,  0, 14, 10},// 0.784316
	{	 74561402201653,   2,  0,  3, 10},// 0.588237
	{	 75221240520477,   2,  0,  3, 10},// 0.294120
	{	 75892858207226,   2,  0,  3, 10},// 1.176472
	{	 76576575636864,   9,  0, 12, 10},// 0.452490
	{	 77272728085518,   9,  0, 12, 10},// 0.452490
	{	 77981650829315,   6,  0,  8, 10},// 0.261437
	{	 78703701496124,  10,  0, 13, 10},// 0.168064
	{	 79439252614975,   3,  0,  4, 10},// 0.705882
	{	 80188676714897,   3,  0,  4, 10},// 0.235291
	{	 80952383577824,  12,  0, 15, 10},// 0.367644
	{	 81730768084526,   8,  0, 10, 10},// 0.106953
	{	 82524269819260,   8,  0, 10, 10},// 0.855613
	{	 83333335816860,   4,  0,  5, 10},// 0.000003
	{	 84158413112164,  10,  0, 12, 10},// 0.542990
	{	 85000000894070,  10,  0, 12, 10},// 0.452490
	{	 85858583450317,   5,  0,  6, 10},// 0.168064
	{	 86734697222710,  12,  0, 14, 10},// 0.078435
	{	 87628863751888,   6,  0,  7, 10},// 0.147056
	{	 88541664183140,   7,  0,  8, 10},// 0.392160
	{	 89238844811916,   7,  0,  8, 10},// 0.392156
	{	 89947089552879,   8,  0,  9, 10},// 0.058824
	{	 90666666626930,   9,  0, 10, 10},// 0.267380
	{	 91397851705551,  10,  0, 11, 10},// 0.294115
	{	 92140920460224,  11,  0, 12, 10},// 0.180997
	{	 92896178364754,  12,  0, 13, 10},// 0.042021
	{	 93663908541203,  14,  0, 15, 10},// 0.091915
	{	 94444446265697,  14,  0, 15, 10},// 0.735296
	{	 95238097012043,  14,  0, 15, 10},// 1.562502
	{	 96045196056366,  14,  0, 15, 10},// 2.389704
	{	 96866093575954,  14,  0, 15, 10},// 3.216908
	{	 97701147198677,   0,  0,  0, 10},// 2.352944
	{	 98550722002983,   0,  0,  0, 10},// 1.470591
	{	 99415205419064,   0,  0,  0, 10},// 0.588235
	{	100294984877110,   0,  0,  0, 10},// 0.294117
	{	101190477609634,   0,  0,  0, 10},// 1.176472
	{	102102100849152,   0,  0,  0, 10},// 2.058822
	{	103030301630497,   0,  0,  0, 10},// 2.941175
	{	103975534439087,  16,  0, 15, 10},// 2.187501
	{	104938268661499,  16,  0, 15, 10},// 1.250003
	{	105919003486633,  16,  0, 15, 10},// 0.312500
	{	106918238103390,  14,  0, 13, 10},// 0.210085
	{	107936508953571,  13,  0, 12, 10},// 0.226245
	{	108974359929562,  11,  0, 10, 10},// 0.106951
	{	110032364726067,  10,  0,  9, 10},// 0.029414
	{	111111111938953,   9,  0,  8, 10},// 0.000001
	{	112211219966412,   8,  0,  7, 10},// 0.257354
	{	113333337008953,  16,  0, 14, 10},// 0.000003
	{	114478111267090,   7,  0,  6, 10},// 0.168064
	{	115646257996559,  14,  0, 12, 10},// 0.226244
	{	116838485002518,   6,  0,  5, 10},// 0.147056
	{	118055552244186,  12,  0, 10, 10},// 0.106955
	{	119298242032528,  18,  0, 15, 10},// 0.459556
	{	120567373931408,   5,  0,  4, 10},// 0.470587
	{	121863797307014,  10,  0,  8, 10},// 0.294119
	{	123188406229019,  15,  0, 12, 10},// 0.090498
	{	124542124569416,   4,  0,  3, 10},// 0.367647
	{	125925928354263,  18,  0, 14, 10},// 0.588233
	{	127340823411942,  13,  0, 10, 10},// 0.053475
	{	128787875175475,   8,  0,  6, 10},// 0.168064
	{	130268201231956,  12,  0,  9, 10},// 0.205884
	{	131782948970795,  20,  0, 15, 10},// 0.404414
	{	132812500000000,   3,  0,  2, 10},// 0.392157
	{	133858263492584,   3,  0,  2, 10},// 0.392154
	{	134920641779900,  18,  0, 13, 10},// 0.588230
	{	136000007390976,  18,  0, 13, 10},// 0.210089
	{	137096777558327,  10,  0,  7, 10},// 0.294115
	{	138211384415627,  17,  0, 12, 10},// 0.180994
	{	139344260096549,   6,  0,  4, 10},// 0.470590
	{	140495866537094,   6,  0,  4, 10},// 0.352940
	{	141666665673256,  16,  0, 11, 10},// 0.000001
	{	142857149243355,   9,  0,  6, 10},// 0.000004
	{	144067794084549,  22,  0, 15, 10},// 0.220586
	{	145299151539803,  15,  0, 10, 10},// 0.106948
	{	146551728248596,  21,  0, 14, 10},// 0.078429
	{	147826090455055,  21,  0, 14, 10},// 0.784316
	{	149122804403305,   2,  0,  1, 10},// 0.588237
	{	150442481040955,   2,  0,  1, 10},// 0.294120
	{	151785716414452,  22,  0, 14, 10},// 1.019606
	{	153153151273727,  22,  0, 14, 10},// 0.117648
	{	154545456171036,  16,  0, 10, 10},// 0.000001
	{	155963301658630,  24,  0, 15, 10},// 0.183824
	{	157407402992249,  10,  0,  6, 10},// 0.168064
	{	158878505229950,  18,  0, 11, 10},// 0.343138
	{	160377353429794,   7,  0,  4, 10},// 0.235291
	{	161904767155647,  20,  0, 12, 10},// 0.226248
	{	163461536169052,  17,  0, 10, 10},// 0.106953
	{	165048539638519,  22,  0, 13, 10},// 0.462182
	{	166666671633720,   4,  0,  2, 10},// 0.000003
	{	168316826224327,  26,  0, 15, 10},// 0.257356
	{	170000001788139,  16,  0,  9, 10},// 0.000001
	{	171717166900635,  11,  0,  6, 10},// 0.168064
	{	173469394445419,  25,  0, 14, 10},// 0.078435
	{	175257727503777,   6,  0,  3, 10},// 0.147056
	{	177083328366280,  22,  0, 12, 10},// 0.090495
	{	178947374224663,  24,  0, 13, 10},// 0.210087
	{	180851057171822,  28,  0, 15, 10},// 0.220592
	{	182795703411102,  10,  0,  5, 10},// 0.294115
	{	184782609343529,  23,  0, 12, 10},// 0.090498
	{	186813190579414,  27,  0, 14, 10},// 0.078433
	{	188888892531395,  16,  0,  8, 10},// 0.000002
	{	191011235117912,  20,  0, 10, 10},// 0.053475
	{	193181812763214,  28,  0, 14, 10},// 0.078434
	{	195402294397354,  30,  0, 15, 10},// 0.845586
	{	197674423456192,   1,  0,  0, 10},// 1.176468
	{	200000002980232,   1,  0,  0, 10},// 0.000001
	{	202380955219269,   1,  0,  0, 10},// 1.176472
	{	204819276928902,  32,  0, 15, 10},// 0.698530
	{	207317069172859,  28,  0, 13, 10},// 0.084032
	{	209876537322998,  20,  0,  9, 10},// 0.058826
	{	212500005960464,  16,  0,  7, 10},// 0.000003
	{	215189874172211,  27,  0, 12, 10},// 0.090497
	{	217948719859123,  23,  0, 10, 10},// 0.106951
	{	220779225230217,  30,  0, 13, 10},// 0.294116
	{	223684206604958,  28,  0, 12, 10},// 0.271491
	{	226666674017906,  33,  0, 14, 10},// 0.000003
	{	229729726910591,  22,  0,  9, 10},// 0.117648
	{	232876718044281,   6,  0,  2, 10},// 0.196076
	{	236111104488373,  25,  0, 10, 10},// 0.106955
	{	239436626434326,  11,  0,  4, 10},// 0.235291
	{	242857143282890,  16,  0,  6, 10},// 0.000000
	{	246376812458038,  31,  0, 12, 10},// 0.090498
	{	250000000000000,   4,  0,  1, 10},// 0.000000
	{	253731340169907,  32,  0, 12, 10},// 0.045250
	{	255639106035233,  22,  0,  8, 10},// 0.032683
	{	257575750350951,  17,  0,  6, 10},// 0.168064
	{	261538475751877,  33,  0, 12, 10},// 0.000005
	{	263565897941589,  28,  0, 10, 10},// 0.026736
	{	265625000000000,   7,  0,  2, 10},// 0.392157
	{	267716526985168,  42,  0, 15, 10},// 0.386033
	{	269841283559798,  26,  0,  9, 10},// 0.058818
	{	272000014781952,  18,  0,  6, 10},// 0.210089
	{	274193555116653,  10,  0,  3, 10},// 0.294115
	{	276422768831253,  35,  0, 12, 10},// 0.180994
	{	278688520193099,  38,  0, 13, 10},// 0.042015
	{	280991733074188,  44,  0, 15, 10},// 0.091913
	{	283333331346512,  16,  0,  5, 10},// 0.000001
	{	285714298486710,  19,  0,  6, 10},// 0.000004
	{	288135588169098,  22,  0,  7, 10},// 0.220586
	{	290598303079605,  31,  0, 10, 10},// 0.106948
	{	293103456497192,  43,  0, 14, 10},// 0.078429
	{	295652180910110,  46,  0, 15, 10},// 0.643385
	{	298245608806610,   2,  0,  0, 10},// 0.588237
	{	300884962081909,   2,  0,  0, 10},// 0.294120
	{	303571432828903,  48,  0, 15, 10},// 0.882352
	{	306306302547455,  48,  0, 15, 10},// 0.018381
	{	309090912342072,  33,  0, 10, 10},// 0.000001
	{	311926603317261,  24,  0,  7, 10},// 0.183824
	{	314814805984497,  21,  0,  6, 10},// 0.168064
	{	317757010459900,  34,  0, 10, 10},// 0.133689
	{	320754706859589,  44,  0, 13, 10},// 0.210087
	{	323809534311295,  41,  0, 12, 10},// 0.226248
	{	326923072338104,  48,  0, 14, 10},// 0.078430
	{	330097079277039,  32,  0,  9, 10},// 0.029409
	{	333333343267441,   9,  0,  2, 10},// 0.000003
	{	336633652448654,  36,  0, 10, 10},// 0.080211
	{	340000003576279,  16,  0,  4, 10},// 0.000001
	{	343434333801270,  54,  0, 15, 10},// 0.091915
	{	346938788890839,  51,  0, 14, 10},// 0.078435
	{	350515455007553,   6,  0,  1, 10},// 0.147056
	{	354166656732559,  45,  0, 12, 10},// 0.090495
	{	357894748449326,  42,  0, 11, 10},// 0.122546
	{	361702114343643,  46,  0, 12, 10},// 0.045245
	{	365591406822205,  10,  0,  2, 10},// 0.294115
	{	369565218687057,  47,  0, 12, 10},// 0.090498
	{	373626381158829,  55,  0, 14, 10},// 0.078433
	{	377777785062790,  33,  0,  8, 10},// 0.000002
	{	382022470235825,  41,  0, 10, 10},// 0.053475
	{	386363625526428,  57,  0, 14, 10},// 0.078434
	{	390804588794708,  42,  0, 10, 10},// 0.026740
	{	395348846912384,  62,  0, 15, 10},// 0.404414
	{	400000005960464,   3,  0,  0, 10},// 0.000001
	{	404761910438538,  64,  0, 15, 10},// 0.367646
	{	409638553857803,  40,  0,  9, 10},// 0.088235
	{	414634138345718,  28,  0,  6, 10},// 0.084032
	{	419753074645996,  20,  0,  4, 10},// 0.058826
	{	425000011920929,  16,  0,  3, 10},// 0.000003
	{	430379748344421,  42,  0,  9, 10},// 0.088236
	{	435897439718246,  60,  0, 13, 10},// 0.042018
	{	441558450460434,  52,  0, 11, 10},// 0.024508
	{	447368413209915,  66,  0, 14, 10},// 0.156861
	{	453333348035812,  67,  0, 14, 10},// 0.000003
	{	459459453821182,  22,  0,  4, 10},// 0.117648
	{	465753436088562,  13,  0,  2, 10},// 0.196076
	{	472222208976746,  51,  0, 10, 10},// 0.106955
	{	478873252868652,  66,  0, 13, 10},// 0.063028
	{	485714286565781,  33,  0,  6, 10},// 0.000000
	{	492753624916077,  68,  0, 13, 10},// 0.021008
	{	500000000000000,   4,  0,  0, 10},// 0.000000
	{	507462680339813,  65,  0, 12, 10},// 0.045250
	{	515151500701903,  66,  0, 12, 10},// 0.045252
	{	523076951503754,  67,  0, 12, 10},// 0.000005
	{	531250000000000,  84,  0, 15, 10},// 0.000000
	{	539682567119597,  26,  0,  4, 10},// 0.058818
	{	548387110233307,  10,  0,  1, 10},// 0.294115
	{	552631556987762,  82,  0, 14, 10},// 0.126988
	{	557377040386199,  38,  0,  6, 10},// 0.042015
	{	566666662693024,  16,  0,  2, 10},// 0.000001
	{	571428596973419,  39,  0,  6, 10},// 0.000004
	{	576271176338196,  74,  0, 12, 10},// 0.113124
	{	580645143985748,  92,  0, 15, 10},// 0.104170
	{	586206912994385,  87,  0, 14, 10},// 0.078429
	{	591549277305603,  70,  0, 11, 10},// 0.019844
	{	596491217613220,  94,  0, 15, 10},// 0.459557
	{	607142865657806,  84,  0, 13, 10},// 0.000001
	{	612903237342834,  48,  0,  7, 10},// 0.065791
	{	618181824684143,  67,  0, 10, 10},// 0.000001
	{	622950792312622,  80,  0, 12, 10},// 0.020247
	{	629629611968994,  62,  0,  9, 10},// 0.058826
	{	634920656681061,  88,  0, 13, 10},// 0.124997
	{	641509413719177,  76,  0, 11, 10},// 0.024513
	{	647058844566345,  96,  0, 14, 10},// 0.060609
	{	653846144676208,  84,  0, 12, 10},// 0.000001
	{	666666686534882,  19,  0,  2, 10},// 0.000003
	{	680000007152557,  33,  0,  4, 10},// 0.000001
	{	688524603843689,  61,  0,  8, 10},// 0.052908
	{	693877577781677, 110,  0, 15, 10},// 0.018386
	{	701754391193390,   6,  0,  0, 10},// 0.250001
	{	708333313465118,  84,  0, 11, 10},// 0.000003
	{	716981112957001,  42,  0,  5, 10},// 0.043857
	{	723404228687286,  93,  0, 12, 10},// 0.045245
	{	730769217014313,  94,  0, 12, 10},// 0.000002
	{	739130437374115,  95,  0, 12, 10},// 0.090498
	{	745098054409027,  81,  0, 10, 10},// 0.047845
	{	755555570125580,  67,  0,  8, 10},// 0.000002
	{	765957474708557,  22,  0,  2, 10},// 0.092589
	{	772727251052856,  84,  0, 10, 10},// 0.000003
	{	782608687877655,  46,  0,  5, 10},// 0.092594
	{	790697693824768,  86,  0, 10, 10},// 0.026736
	{	800000011920929,   7,  0,  0, 10},// 0.000001
	{	809523820877075,  88,  0, 10, 10},// 0.053477
	{	818181812763214,  89,  0, 10, 10},// 0.000001
	{	829268276691437,  57,  0,  6, 10},// 0.084032
	{	837209284305573,  66,  0,  7, 10},// 0.034724
	{	850000023841858,  16,  0,  1, 10},// 0.000003
	{	857142865657806,  59,  0,  6, 10},// 0.000001
	{	863636374473572,  94,  0, 10, 10},// 0.000001
	{	871794879436493,  60,  0,  6, 10},// 0.042018
	{	883720934391022,  52,  0,  5, 10},// 0.043860
	{	894736826419830,  12, 10, 15, 10},// 0.110292
	{	904761910438538,  28,  4, 15, 10},// 0.164473
	{	918918907642365,  48,  2, 15, 10},// 0.018381
	{	926829278469086, 101,  0, 10, 10},// 0.047846
	{	936170220375061, 102,  0, 10, 10},// 0.020660
	{	944444417953491,  84,  0,  8, 10},// 0.000003
	{	952380955219269,  12, 10, 14, 10},// 0.100000
	{	959999978542328,  47,  0,  4, 10},// 0.000002
	{	971428573131561,  67,  0,  6, 10},// 0.000000
	{	978723406791687,  87,  0,  8, 10},// 0.096619
	{  1000000000000000,   9,  0,  0, 10},// 0.000000
	{  1022222280502318,  91,  0,  8, 10},// 0.000006
	{  1030303001403809, 102,  0,  9, 10},// 0.029409
	{  1043478250503540,  72,  0,  6, 10},// 0.059523
	{  1052631616592407,  78,  1, 14, 10},// 0.066663
	{  1062500000000000,  84,  0,  7, 10},// 0.000000
	{  1076923131942749,  69,  1, 12, 10},// 0.000005
	{  1085714340209961,  75,  0,  6, 10},// 0.000005
	{  1096774220466614,  34,  4, 15, 10},// 0.275738
	{  1105263113975524,  58,  2, 15, 10},// 0.089290
	{  1117647051811218, 122,  0, 10, 10},// 0.047848
	{  1133333325386047,  33,  0,  2, 10},// 0.000001
	{  1142857193946838,  79,  0,  6, 10},// 0.000004
	{  1151515126228333,  22,  0,  1, 10},// 0.131577
	{  1161290287971497,  92,  0,  7, 10},// 0.104170
	{  1172413825988770,  42,  2, 10, 10},// 0.026735
	{  1187500000000000,  94,  0,  7, 10},// 0.000000
	{  1200000047683716,  11,  0,  0, 10},// 0.000004
	{  1214285731315613,  84,  0,  6, 10},// 0.000001
	{  1225806474685669,  48,  0,  3, 10},// 0.065791
	{  1241379261016846,  61,  0,  4, 10},// 0.111107
	{  1259259223937988,  62,  0,  4, 10},// 0.058826
	{  1272727251052856,  69,  1, 10, 10},// 0.000002
	{  1285714268684387,  89,  0,  6, 10},// 0.000001
	{  1297297239303588,  12,  0,  0, 10},// 0.208338
	{  1307692289352417,  84,  1, 12, 10},// 0.000001
	{  1333333373069763,  39,  0,  2, 10},// 0.000003
	{  1360000014305115,  67,  0,  4, 10},// 0.000001
	{  1371428608894348,  95,  0,  6, 10},// 0.000003
	{  1384615421295166,  89,  1, 12, 10},// 0.000003
	{  1399999976158142,  13,  0,  0, 10},// 0.000002
	{  1416666626930237,  84,  0,  5, 10},// 0.000003
	{  1428571462631226,  99,  0,  6, 10},// 0.000002
	{  1440000057220459,  71,  0,  4, 10},// 0.000004
	{  1461538434028625,  94,  1, 12, 10},// 0.000002
	{  1478260874748230,  68,  2, 13, 10},// 0.021008
	{  1500000000000000,  14,  0,  0, 10},// 0.000000
	{  1519999980926514,  75,  0,  4, 10},// 0.000001
	{  1533333301544189,  45,  0,  2, 10},// 0.000002
	{  1545454502105713,  84,  1, 10, 10},// 0.000003
	{  1565217375755310,  72,  2, 13, 10},// 0.059523
	{  1583333373069763,  94,  0,  5, 10},// 0.000003
	{  1600000023841858,  15,  0,  0, 10},// 0.000001
	{  1619047641754150,  36,  6, 15, 10},// 0.018384
	{  1636363625526428,  89,  1, 10, 10},// 0.000001
	{  1652173876762390, 123,  1, 14, 10},// 0.070178
	{  1666666626930237,  49,  0,  2, 10},// 0.000002
	{  1679999947547913,  83,  0,  4, 10},// 0.000003
	{  1700000047683716,  16,  0,  0, 10},// 0.000003
	{  1714285731315613, 119,  0,  6, 10},// 0.000001
	{  1727272748947144,  94,  1, 10, 10},// 0.000001
	{  1750000000000000,  34,  0,  1, 10},// 0.000000
	{  1769230723381042, 114,  1, 12, 10},// 0.000003
	{  1789473652839661,  22,  6,  8, 10},// 0.032678
	{  1809523820877075,  30,  6, 11, 10},// 0.065790
	{  1826086997985839,  72,  0,  3, 10},// 0.059526
	{  1840000033378601,  91,  0,  4, 10},// 0.000002
	{  1888888835906982,  84,  1,  8, 10},// 0.000003
	{  1904761910438538,  60,  4, 15, 10},// 0.078125
	{  1919999957084656,  95,  0,  4, 10},// 0.000002
	{  2000000000000000,  19,  0,  0, 10},// 0.000000
	{  2086956501007080,  72,  1,  6, 10},// 0.059523
	{  2105263233184814,  78,  3, 14, 10},// 0.066663
	{  2125000000000000,  84,  0,  3, 10},// 0.000000
	{  2190476179122924,  72,  2,  9, 10},// 0.021739
	{  2210526227951049,  16, 12,  9, 10},// 0.023806
	{  2235294103622437, 122,  1, 10, 10},// 0.047848
	{  2266666650772095,  67,  0,  2, 10},// 0.000001
	{  2285714387893677,  79,  1,  6, 10},// 0.000004
	{  2315789461135864,  42,  6, 12, 10},// 0.017482
	{  2333333253860474,  69,  0,  2, 10},// 0.000003
	{  2352941274642944, 101,  2, 12, 10},// 0.038457
	{  2375000000000000,  94,  0,  3, 10},// 0.000000
	{  2400000095367432,  23,  0,  0, 10},// 0.000004
	{  2428571462631226,  84,  1,  6, 10},// 0.000001
	{  2470588207244873,  18, 12,  9, 10},// 0.023808
	{  2500000000000000,  24,  0,  0, 10},// 0.000000
	{  2533333301544189,  75,  0,  2, 10},// 0.000001
	{  2571428537368774,  89,  1,  6, 10},// 0.000001
	{  2615384578704834,  84,  3, 12, 10},// 0.000001
	{  2666666746139526,  79,  0,  2, 10},// 0.000003
	{  2714285612106323,  94,  1,  6, 10},// 0.000004
	{  2769230842590332, 119,  2, 12, 10},// 0.000003
	{  2799999952316284,  27,  0,  0, 10},// 0.000002
	{  2833333253860474,  84,  0,  2, 10},// 0.000003
	{  2857142925262451,  99,  1,  6, 10},// 0.000002
	{  2923076868057251,  94,  3, 12, 10},// 0.000002
	{  3000000000000000,  29,  0,  0, 10},// 0.000000
	{  3066666603088379,  91,  0,  2, 10},// 0.000002
	{  3090909004211426,  84,  3, 10, 10},// 0.000003
	{  3142857074737549, 109,  1,  6, 10},// 0.000002
	{  3166666746139526,  94,  0,  2, 10},// 0.000003
	{  3200000047683716,  31,  0,  0, 10},// 0.000001
	{  3230769157409668, 104,  3, 12, 10},// 0.000002
	{  3272727251052856, 119,  2, 10, 10},// 0.000001
	{  3333333253860474,  99,  0,  2, 10},// 0.000002
	{  3400000095367432,  33,  0,  0, 10},// 0.000003
	{  3428571462631226, 119,  1,  6, 10},// 0.000001
	{  3454545497894287,  94,  3, 10, 10},// 0.000001
	{  3500000000000000,  34,  0,  0, 10},// 0.000000
	{  3538461446762085, 114,  3, 12, 10},// 0.000003
	{  3599999904632568,  35,  0,  0, 10},// 0.000003
	{  3636363744735718,  99,  3, 10, 10},// 0.000003
	{  3666666746139526, 109,  0,  2, 10},// 0.000002
	{  3777777671813965,  84,  3,  8, 10},// 0.000003
	{  3818181753158569, 104,  3, 10, 10},// 0.000002
	{  4000000000000000,  39,  0,  0, 10},// 0.000000
	{  4199999809265136,  41,  0,  0, 10},// 0.000005
	{  4250000000000000,  84,  0,  1, 10},// 0.000000
	{  4363636493682861, 119,  3, 10, 10},// 0.000003
	{  4400000095367431,  43,  0,  0, 10},// 0.000002
	{  4444444656372070,  99,  3,  8, 10},// 0.000005
	{  4500000000000000,  44,  0,  0, 10},// 0.000000
	{  4599999904632568,  45,  0,  0, 10},// 0.000002
	{  4666666507720947,  69,  1,  2, 10},// 0.000003
	{  4750000000000000,  94,  0,  1, 10},// 0.000000
	{  4800000190734863,  47,  0,  0, 10},// 0.000004
	{  4857142925262451,  84,  3,  6, 10},// 0.000001
	{  5000000000000000,  49,  0,  0, 10},// 0.000000
	{  5142857074737549, 119,  2,  6, 10},// 0.000001
	{  5250000000000000, 104,  0,  1, 10},// 0.000000
	{  5333333492279053,  79,  1,  2, 10},// 0.000003
	{  5428571224212646,  94,  3,  6, 10},// 0.000004
	{  5500000000000000,  54,  0,  0, 10},// 0.000000
	{  5666666507720947,  84,  1,  2, 10},// 0.000003
	{  5714285850524902,  99,  3,  6, 10},// 0.000002
	{  6000000000000000,  59,  0,  0, 10},// 0.000000
	{  6285714149475098, 109,  3,  6, 10},// 0.000002
	{  6333333492279053,  94,  1,  2, 10},// 0.000003
	{  6571428775787354, 114,  3,  6, 10},// 0.000003
	{  6666666507720947,  99,  1,  2, 10},// 0.000002
	{  6800000190734863,  67,  0,  0, 10},// 0.000003
	{  6857142925262451, 119,  3,  6, 10},// 0.000001
	{  7000000000000000,  69,  0,  0, 10},// 0.000000
	{  7199999809265137,  71,  0,  0, 10},// 0.000003
	{  7333333492279053, 109,  1,  2, 10},// 0.000002
	{  7599999904632568,  75,  0,  0, 10},// 0.000001
	{  7666666507720947, 114,  1,  2, 10},// 0.000002
	{  8000000000000000,  79,  0,  0, 10},// 0.000000
	{  8399999618530273,  83,  0,  0, 10},// 0.000005
	{  8500000000000000,  84,  0,  0, 10},// 0.000000
	{  8800000190734863,  87,  0,  0, 10},// 0.000002
	{  9000000000000000,  89,  0,  0, 10},// 0.000000
	{  9199999809265136,  91,  0,  0, 10},// 0.000002
	{  9500000000000000,  94,  0,  0, 10},// 0.000000
	{  9600000381469726,  95,  0,  0, 10},// 0.000004
	{ 10000000000000000,  99,  0,  0, 10},// 0.000000
	{ 10500000000000000, 104,  0,  0, 10},// 0.000000
	{ 11000000000000000, 109,  0,  0, 10},// 0.000000
	{ 11333333015441894,  84,  3,  2, 10},// 0.000003
	{ 11500000000000000, 114,  0,  0, 10},// 0.000000
	{ 12000000000000000, 119,  0,  0, 10},// 0.000000
	{ 12362637333333333,  52,  6,  2, 10},// 0.032593
	{ 12375000000000000,  98,  4,  3, 10},// 0.000000
	{ 12666666984558106,  94,  3,  2, 10},// 0.000003
	{ 13333333015441894,  99,  3,  2, 10},// 0.000002
	{ 14000000000000000,  69,  1,  0, 10},// 0.000000
	{ 14666666984558106, 109,  3,  2, 10},// 0.000002
	{ 15333333015441894, 114,  3,  2, 10},// 0.000002
	{ 16000000000000000,  79,  1,  0, 10},// 0.000000
	{ 17000000000000000,  84,  1,  0, 10},// 0.000000
	{ 18000000000000000,  89,  1,  0, 10},// 0.000000
	{ 19000000000000000,  94,  1,  0, 10},// 0.000000
	{ 20000000000000000,  99,  1,  0, 10},// 0.000000
	{ 21000000000000000, 104,  1,  0, 10},// 0.000000
	{ 22000000000000000, 109,  1,  0, 10},// 0.000000
	{ 23000000000000000, 114,  1,  0, 10},// 0.000000
	{ 24000000000000000, 119,  1,  0, 10},// 0.000000
	{ 24725274666666666,  98,  4,  1, 10},// 0.100000
	{ 24750000000000000,  98,  4,  1, 10},// 0.000000
};

EXPORT_SYMBOL(ambarella_rct_pll_table);

u32 ambarella_rct_find_pll_table_index(unsigned long rate, u32 pre_scaler,
	const struct pll_table_s *p_table, u32 table_size)
{
	u64 divident;
	u64 divider;
	u32 start;
	u32 middle;
	u32 end;
	u32 index_limit;
	u64 diff = 0;
	u64 diff_low = 0xFFFFFFFFFFFFFFFF;
	u64 diff_high = 0xFFFFFFFFFFFFFFFF;

	pr_debug("pre_scaler = [0x%08X]\n", pre_scaler);

	divident = rate;
	divident *= pre_scaler;
	divident *= (1000 * 1000 * 1000);
	divider = (ambarella_clk_ref_freq / (1000 * 1000));
	AMBCLK_DO_DIV(divident, divider);

	index_limit = (table_size - 1);
	start = 0;
	end = index_limit;
	middle = table_size / 2;
	while (p_table[middle].multiplier != divident) {
		if (p_table[middle].multiplier < divident) {
			start = middle;
		} else {
			end = middle;
		}
		middle = (start + end) / 2;
		if (middle == start || middle == end) {
			break;
		}
	}
	if ((middle > 0) && ((middle + 1) <= index_limit)) {
		if (p_table[middle - 1].multiplier < divident) {
			diff_low = (divident -
				p_table[middle - 1].multiplier);
		} else {
			diff_low = (p_table[middle - 1].multiplier -
				divident);
		}
		if (p_table[middle].multiplier < divident) {
			diff = (divident - p_table[middle].multiplier);
		} else {
			diff = (p_table[middle].multiplier - divident);
		}
		if (p_table[middle + 1].multiplier < divident) {
			diff_high = (divident -
				p_table[middle + 1].multiplier);
		} else {
			diff_high = (p_table[middle + 1].multiplier -
				divident);
		}
		pr_debug("multiplier[%u] = [%llu]\n", (middle - 1),
			p_table[middle - 1].multiplier);
		pr_debug("multiplier[%u] = [%llu]\n", (middle),
			p_table[middle].multiplier);
		pr_debug("multiplier[%u] = [%llu]\n", (middle + 1),
			p_table[middle + 1].multiplier);
	} else if ((middle == 0) && ((middle + 1) <= index_limit)) {
		if (p_table[middle].multiplier < divident) {
			diff = (divident - p_table[middle].multiplier);
		} else {
			diff = (p_table[middle].multiplier - divident);
		}
		if (p_table[middle + 1].multiplier < divident) {
			diff_high = (divident -
				p_table[middle + 1].multiplier);
		} else {
			diff_high = (p_table[middle + 1].multiplier -
				divident);
		}
		pr_debug("multiplier[%u] = [%llu]\n", (middle),
			p_table[middle].multiplier);
		pr_debug("multiplier[%u] = [%llu]\n", (middle + 1),
			p_table[middle + 1].multiplier);
	} else if ((middle > 0) && ((middle + 1) > index_limit)) {
		if (p_table[middle - 1].multiplier < divident) {
			diff_low = (divident -
				p_table[middle - 1].multiplier);
		} else {
			diff_low = (p_table[middle - 1].multiplier -
				divident);
		}
		if (p_table[middle].multiplier < divident) {
			diff = (divident - p_table[middle].multiplier);
		} else {
			diff = (p_table[middle].multiplier - divident);
		}
		pr_debug("multiplier[%u] = [%llu]\n", (middle - 1),
			p_table[middle - 1].multiplier);
		pr_debug("multiplier[%u] = [%llu]\n", (middle),
			p_table[middle].multiplier);
	}
	pr_debug("diff_low = [%llu]\n", diff_low);
	pr_debug("diff = [%llu]\n", diff);
	pr_debug("diff_high = [%llu]\n", diff_high);
	if (diff_low < diff) {
		if (middle) {
			middle--;
		}
	}
	if (diff_high < diff) {
		middle++;
		if (middle > index_limit) {
			middle = index_limit;
		}
	}
	pr_debug("middle = [%u]\n", middle);

	return middle;
}
EXPORT_SYMBOL(ambarella_rct_find_pll_table_index);

/* ==========================================================================*/
unsigned long ambarella_rct_clk_get_rate(struct clk *c)
{
	union ctrl_reg_u ctrl_reg;
	union frac_reg_u frac_reg;
	u32 pre_scaler_reg;
	u32 post_scaler_reg;
	u32 pll_int;
	u32 sdiv;
	u32 sout;
	u64 divident;
	u64 divider;
	u64 frac;

	if (c->ctrl_reg != PLL_REG_UNAVAILABLE) {
		ctrl_reg.w = amba_rct_readl(c->ctrl_reg);
		if ((ctrl_reg.s.power_down == 1) ||
			(ctrl_reg.s.halt_vco == 1)) {
			c->rate = 0;
			goto ambarella_rct_clk_get_rate_exit;
		}
	} else {
		ctrl_reg.w = 0;
	}
	if (c->frac_reg != PLL_REG_UNAVAILABLE) {
		frac_reg.w = amba_rct_readl(c->frac_reg);
	} else {
		frac_reg.w = 0;
	}
	if (c->pres_reg != PLL_REG_UNAVAILABLE) {
		pre_scaler_reg = amba_rct_readl(c->pres_reg);
		if (c->extra_scaler == 1) {
			pre_scaler_reg >>= 4;
			pre_scaler_reg++;
		}
	} else {
		pre_scaler_reg = 1;
	}
	if (c->post_reg != PLL_REG_UNAVAILABLE) {
		post_scaler_reg = amba_rct_readl(c->post_reg);
		if (c->extra_scaler == 1) {
			post_scaler_reg >>= 4;
			post_scaler_reg++;
		}
	} else {
		post_scaler_reg = 1;
	}

	pll_int = ctrl_reg.s.intp;
	sdiv = ctrl_reg.s.sdiv;
	sout = ctrl_reg.s.sout;

	divident = (u64)ambarella_clk_ref_freq;
	divident *= (u64)(pll_int + 1);
	divident *= (u64)(sdiv + 1);
	divider = (pre_scaler_reg * (sout + 1) * post_scaler_reg);
	if (c->divider) {
		divider *= c->divider;
	}
	if (ctrl_reg.s.frac_mode) {
		if (frac_reg.s.nega) {
			/* Negative */
			frac = (0x80000000 - frac_reg.s.frac);
			frac = (ambarella_clk_ref_freq * frac * (sdiv + 1));
			frac >>= 32;
			divident = divident - frac;
		} else {
			/* Positive */
			frac = frac_reg.s.frac;
			frac = (ambarella_clk_ref_freq * frac * (sdiv + 1));
			frac >>= 32;
			divident = divident + frac;
		}
	}
	if (divider == 0) {
		c->rate = 0;
		return c->rate;
	}
	AMBCLK_DO_DIV(divident, divider);
	c->rate = divident;

ambarella_rct_clk_get_rate_exit:
	return c->rate;
}
EXPORT_SYMBOL(ambarella_rct_clk_get_rate);

int ambarella_rct_clk_set_rate(struct clk *c, unsigned long rate)
{
	int ret_val = -1;
	u32 pre_scaler;
	u32 post_scaler;
	u32 ctrl2;
	u32 ctrl3;
	u64 divident;
	u64 divider;
	u32 middle;
	union ctrl_reg_u ctrl_reg;
	union frac_reg_u frac_reg;
	u64 diff;

	if (c->divider) {
		rate *= c->divider;
	}
	if (!rate) {
		ret_val = -1;
		goto ambarella_rct_clk_set_rate_exit;
	}

	if ((c->ctrl_reg == PLL_REG_UNAVAILABLE) &&
		(c->frac_reg == PLL_REG_UNAVAILABLE) &&
		(c->ctrl2_reg == PLL_REG_UNAVAILABLE) &&
		(c->ctrl3_reg == PLL_REG_UNAVAILABLE) &&
		(c->pres_reg == PLL_REG_UNAVAILABLE) &&
		(c->post_reg != PLL_REG_UNAVAILABLE) && c->max_divider) {
		divider = (ambarella_clk_ref_freq + (rate >> 1) - 1) / rate;
		if (!divider) {
			ret_val = -1;
			goto ambarella_rct_clk_set_rate_exit;
		}
		if (divider > c->max_divider) {
			divider = c->max_divider;
		}
		post_scaler = divider;
		if (c->extra_scaler == 0) {
			amba_rct_writel(c->post_reg, post_scaler);
		} else if (c->extra_scaler == 1) {
			post_scaler--;
			post_scaler <<= 4;
			amba_rct_writel_en(c->post_reg, post_scaler);
		}
		ret_val = 0;
		goto ambarella_rct_clk_set_rate_exit;
	}

	if ((c->ctrl_reg != PLL_REG_UNAVAILABLE) &&
		(c->post_reg != PLL_REG_UNAVAILABLE)) {
		if (c->pres_reg != PLL_REG_UNAVAILABLE) {
			pre_scaler = amba_rct_readl(c->pres_reg);
			if (c->extra_scaler == 1) {
				pre_scaler >>= 4;
				pre_scaler++;
			}
		} else {
			pre_scaler = 1;
		}

		middle = ambarella_rct_find_pll_table_index(rate, pre_scaler,
			ambarella_rct_pll_table, AMBARELLA_RCT_PLL_TABLE_SIZE);

		ctrl_reg.w = amba_rct_readl(c->ctrl_reg);
		ctrl_reg.s.intp = ambarella_rct_pll_table[middle].intp;
		ctrl_reg.s.sdiv = ambarella_rct_pll_table[middle].sdiv;
		ctrl_reg.s.sout = ambarella_rct_pll_table[middle].sout;
		ctrl_reg.s.bypass = 0;
		ctrl_reg.s.frac_mode = 0;
		ctrl_reg.s.force_reset = 0;
		ctrl_reg.s.power_down = 0;
		ctrl_reg.s.halt_vco = 0;
		ctrl_reg.s.tristate = 0;
		ctrl_reg.s.force_lock = 1;
		ctrl_reg.s.force_bypass = 0;
		ctrl_reg.s.write_enable = 0;
		amba_rct_writel_en(c->ctrl_reg, ctrl_reg.w);

		post_scaler = ambarella_rct_pll_table[middle].post;
		if (c->extra_scaler == 0) {
			amba_rct_writel(c->post_reg, post_scaler);
		} else if (c->extra_scaler == 1) {
			post_scaler--;
			post_scaler <<= 4;
			amba_rct_writel_en(c->post_reg, post_scaler);
		}

		if (c->frac_mode) {
			c->rate = ambarella_rct_clk_get_rate(c);
			if (c->rate < rate) {
				diff = rate - c->rate;
			} else {
				diff = c->rate - rate;
			}
			divident = (diff * pre_scaler *
				(ambarella_rct_pll_table[middle].sout + 1) *
				ambarella_rct_pll_table[middle].post);
			divident = divident << 32;
			divider = ((u64)ambarella_clk_ref_freq *
				(ambarella_rct_pll_table[middle].sdiv + 1));
			AMBCLK_DO_DIV_ROUND(divident, divider);
			if (c->rate <= rate) {
				frac_reg.s.nega	= 0;
				frac_reg.s.frac	= divident;
			} else {
				frac_reg.s.nega	= 1;
				frac_reg.s.frac	= 0x80000000 - divident;
			}
			amba_rct_writel(c->frac_reg, frac_reg.w);

			ctrl_reg.w = amba_rct_readl(c->ctrl_reg);
			if (diff) {
				ctrl_reg.s.frac_mode = 1;
			} else {
				ctrl_reg.s.frac_mode = 0;
			}
			ctrl_reg.s.force_lock = 1;
			ctrl_reg.s.write_enable = 1;
			amba_rct_writel(c->ctrl_reg, ctrl_reg.w);

			ctrl_reg.s.write_enable	= 0;
			amba_rct_writel(c->ctrl_reg, ctrl_reg.w);
		}
		if (ctrl_reg.s.frac_mode) {
			ctrl2 = 0x3f770000;
			ctrl3 = 0x00069300;
		} else {
			ctrl2 = 0x3f770000;
			ctrl3 = 0x00068300;
		}

		if (c->ctrl2_reg != PLL_REG_UNAVAILABLE) {
			amba_rct_writel(c->ctrl2_reg, ctrl2);
		}
		if (c->ctrl3_reg != PLL_REG_UNAVAILABLE) {
			amba_rct_writel(c->ctrl3_reg, ctrl3);
		}
	}
	ret_val = 0;

ambarella_rct_clk_set_rate_exit:
	c->rate = ambarella_rct_clk_get_rate(c);
	return ret_val;
}
EXPORT_SYMBOL(ambarella_rct_clk_set_rate);

int ambarella_rct_clk_enable(struct clk *c)
{
	union ctrl_reg_u ctrl_reg;

	if (c->ctrl_reg == PLL_REG_UNAVAILABLE) {
		return -1;
	}

	ctrl_reg.w = amba_rct_readl(c->ctrl_reg);
	ctrl_reg.s.power_down = 0;
	ctrl_reg.s.halt_vco = 0;
	ctrl_reg.s.write_enable = 1;
	amba_rct_writel(c->ctrl_reg, ctrl_reg.w);

	ctrl_reg.s.write_enable	= 0;
	amba_rct_writel(c->ctrl_reg, ctrl_reg.w);

	c->rate = ambarella_rct_clk_get_rate(c);

	return 0;
}
EXPORT_SYMBOL(ambarella_rct_clk_enable);

int ambarella_rct_clk_disable(struct clk *c)
{
	union ctrl_reg_u ctrl_reg;

	if (c->ctrl_reg == PLL_REG_UNAVAILABLE) {
		return -1;
	}

	ctrl_reg.w = amba_rct_readl(c->ctrl_reg);
	ctrl_reg.s.power_down = 1;
	ctrl_reg.s.halt_vco = 1;
	ctrl_reg.s.write_enable = 1;
	amba_rct_writel(c->ctrl_reg, ctrl_reg.w);

	ctrl_reg.s.write_enable	= 0;
	amba_rct_writel(c->ctrl_reg, ctrl_reg.w);

	c->rate = ambarella_rct_clk_get_rate(c);

	return 0;
}
EXPORT_SYMBOL(ambarella_rct_clk_disable);

struct clk_ops ambarella_rct_pll_ops = {
	.enable		= ambarella_rct_clk_enable,
	.disable	= ambarella_rct_clk_disable,
	.get_rate	= ambarella_rct_clk_get_rate,
	.round_rate	= NULL,
	.set_rate	= ambarella_rct_clk_set_rate,
	.set_parent	= NULL,
};
EXPORT_SYMBOL(ambarella_rct_pll_ops);

/* ==========================================================================*/
unsigned long ambarella_rct_scaler_get_rate(struct clk *c)
{
	u32 divider;

	if (!c->parent || !c->parent->ops || !c->parent->ops->get_rate) {
		return 0;
	}

	if (c->divider) {
		c->rate = c->parent->ops->get_rate(c->parent) / c->divider;
		return c->rate;
	}

	if (c->post_reg != PLL_REG_UNAVAILABLE) {
		divider = amba_rct_readl(c->post_reg);
		if (c->extra_scaler == 1) {
			divider >>= 4;
			divider++;
		}
		if (divider) {
			c->rate = c->parent->ops->get_rate(c->parent) / divider;
			return c->rate;
		}
	}

	return 0;
}
EXPORT_SYMBOL(ambarella_rct_scaler_get_rate);

int ambarella_rct_scaler_set_rate(struct clk *c, unsigned long rate)
{
	u32 divider;
	u32 post_scaler;

	if (!c->parent || !c->parent->ops || !c->parent->ops->get_rate) {
		return -1;
	}
	if (c->post_reg == PLL_REG_UNAVAILABLE) {
		return -1;
	}
	if (!c->max_divider) {
		return -1;
	}
	if (c->divider) {
		rate *= c->divider;
	}
	if (!rate) {
		return -1;
	}

	divider = ((c->parent->ops->get_rate(c->parent) + (rate >> 2) - 1) /
		rate);
	if (!divider) {
		return -1;
	}
	if (divider > c->max_divider) {
		divider = c->max_divider;
	}

	post_scaler = divider;
	if (c->extra_scaler == 0) {
		amba_rct_writel(c->post_reg, post_scaler);
	} else if (c->extra_scaler == 1) {
		post_scaler--;
		post_scaler <<= 4;
		amba_rct_writel_en(c->post_reg, post_scaler);
	}

	c->rate = ambarella_rct_scaler_get_rate(c);

	return 0;
}
EXPORT_SYMBOL(ambarella_rct_scaler_set_rate);

struct clk_ops ambarella_rct_scaler_ops = {
	.enable		= NULL,
	.disable	= NULL,
	.get_rate	= ambarella_rct_scaler_get_rate,
	.round_rate	= NULL,
	.set_rate	= ambarella_rct_scaler_set_rate,
	.set_parent	= NULL,
};
EXPORT_SYMBOL(ambarella_rct_scaler_ops);

/* ==========================================================================*/
struct clk *clk_get_sys(const char *dev_id, const char *con_id)
{
	struct clk *p;
	struct clk *clk = ERR_PTR(-ENOENT);

	spin_lock(&ambarella_clock_lock);
	list_for_each_entry(p, &ambarella_all_clocks, list) {
		if (dev_id && (strcmp(p->name, dev_id) == 0)) {
			clk = p;
			break;
		}
		if (con_id && (strcmp(p->name, con_id) == 0)) {
			clk = p;
			break;
		}
	}
	spin_unlock(&ambarella_clock_lock);

	return clk;
}
EXPORT_SYMBOL(clk_get_sys);

struct clk *clk_get(struct device *dev, const char *id)
{
	struct clk *p;
	struct clk *clk = ERR_PTR(-ENOENT);

	if (id == NULL) {
		return clk;
	}

	spin_lock(&ambarella_clock_lock);
	list_for_each_entry(p, &ambarella_all_clocks, list) {
		if (strcmp(p->name, id) == 0) {
			clk = p;
			break;
		}
	}
	spin_unlock(&ambarella_clock_lock);

	return clk;
}
EXPORT_SYMBOL(clk_get);

void clk_put(struct clk *clk)
{
}
EXPORT_SYMBOL(clk_put);

int clk_enable(struct clk *clk)
{
	if (IS_ERR(clk) || (clk == NULL)) {
		return -EINVAL;
	}

	clk_enable(clk->parent);

	spin_lock(&ambarella_clock_lock);
	if (clk->ops && clk->ops->enable) {
		(clk->ops->enable)(clk);
	}
	spin_unlock(&ambarella_clock_lock);

	return 0;
}
EXPORT_SYMBOL(clk_enable);

void clk_disable(struct clk *clk)
{
	if (IS_ERR(clk) || (clk == NULL)) {
		return;
	}

	spin_lock(&ambarella_clock_lock);
	if (clk->ops && clk->ops->disable) {
		(clk->ops->disable)(clk);
	}
	spin_unlock(&ambarella_clock_lock);

	clk_disable(clk->parent);
}
EXPORT_SYMBOL(clk_disable);

unsigned long clk_get_rate(struct clk *clk)
{
	if (IS_ERR(clk) || (clk == NULL)) {
		return 0;
	}

	if (clk->ops != NULL && clk->ops->get_rate != NULL) {
		return (clk->ops->get_rate)(clk);
	}

	if (clk->parent != NULL) {
		return clk_get_rate(clk->parent);
	}

	return clk->rate;
}
EXPORT_SYMBOL(clk_get_rate);

long clk_round_rate(struct clk *clk, unsigned long rate)
{
	if (IS_ERR(clk) || (clk == NULL)) {
		return rate;
	}

	if (clk->ops && clk->ops->round_rate) {
		return (clk->ops->round_rate)(clk, rate);
	}

	return rate;
}
EXPORT_SYMBOL(clk_round_rate);

int clk_set_rate(struct clk *clk, unsigned long rate)
{
	int ret;

	if (IS_ERR(clk) || (clk == NULL)) {
		return -EINVAL;
	}

	if ((clk->ops == NULL) || (clk->ops->set_rate == NULL)) {
		return -EINVAL;
	}

	spin_lock(&ambarella_clock_lock);
	ret = (clk->ops->set_rate)(clk, rate);
	spin_unlock(&ambarella_clock_lock);

	return ret;
}
EXPORT_SYMBOL(clk_set_rate);

struct clk *clk_get_parent(struct clk *clk)
{
	if (IS_ERR(clk) || (clk == NULL)) {
		return ERR_PTR(-EINVAL);
	}

	return clk->parent;
}
EXPORT_SYMBOL(clk_get_parent);

int clk_set_parent(struct clk *clk, struct clk *parent)
{
	int ret = 0;

	if (IS_ERR(clk) || (clk == NULL)) {
		return -EINVAL;
	}

	spin_lock(&ambarella_clock_lock);
	if (clk->ops && clk->ops->set_parent) {
		ret = (clk->ops->set_parent)(clk, parent);
	}
	spin_unlock(&ambarella_clock_lock);

	return ret;
}
EXPORT_SYMBOL(clk_set_parent);

int ambarella_clk_add(struct clk *clk)
{
	spin_lock(&ambarella_clock_lock);
	list_add(&clk->list, &ambarella_all_clocks);
	spin_unlock(&ambarella_clock_lock);

	return 0;
}
EXPORT_SYMBOL(ambarella_clk_add);

/* ==========================================================================*/
#if defined(CONFIG_AMBARELLA_PLL_PROC)
static int ambarella_clock_proc_show(struct seq_file *m, void *v)
{
	int retlen = 0;
	struct clk *p;

	retlen += seq_printf(m, "\nClock Information:\n");
	spin_lock(&ambarella_clock_lock);
	list_for_each_entry(p, &ambarella_all_clocks, list) {
		retlen += seq_printf(m, "\t%s:\t%lu Hz\n",
			p->name, p->ops->get_rate(p));
	}
	spin_unlock(&ambarella_clock_lock);

	return retlen;
}

static ssize_t ambarella_clock_proc_write(struct file *file,
	const char __user *buffer, size_t count, loff_t *ppos)
{
	int ret_val = 0;
	unsigned long usr_val;
	u32 freq_hz;
	u32 pre_scaler;
	u32 ctrl2;
	u32 ctrl3;
	u64 divident;
	u64 divider;
	u32 middle;
	union ctrl_reg_u ctrl_reg;
	union frac_reg_u frac_reg;
	u64 diff;
	u32 freq_hz_int;

	ret_val = kstrtoul_from_user(buffer, count, 0, &usr_val);
	if (ret_val) {
		goto ambarella_clock_proc_write_exit;
	}
	freq_hz = usr_val;
	pre_scaler = 1;

	middle = ambarella_rct_find_pll_table_index(freq_hz, pre_scaler,
		ambarella_rct_pll_table, AMBARELLA_RCT_PLL_TABLE_SIZE);

	ctrl_reg.w = 0;
	ctrl_reg.s.intp = ambarella_rct_pll_table[middle].intp;
	ctrl_reg.s.sdiv = ambarella_rct_pll_table[middle].sdiv;
	ctrl_reg.s.sout = ambarella_rct_pll_table[middle].sout;
	ctrl_reg.s.frac_mode = 0;
	ctrl_reg.s.force_lock = 1;
	ctrl_reg.s.write_enable = 0;

	pr_info("post_scaler = [0x%08X]\n",
		ambarella_rct_pll_table[middle].post);

	divident = (ambarella_clk_ref_freq * (ctrl_reg.s.intp + 1) *
		(ctrl_reg.s.sdiv + 1));
	divider = (pre_scaler * (ctrl_reg.s.sout + 1) *
		ambarella_rct_pll_table[middle].post);
	AMBCLK_DO_DIV(divident, divider);
	freq_hz_int = divident;
	if (freq_hz_int < freq_hz) {
		diff = freq_hz - freq_hz_int;
	} else {
		diff = freq_hz_int - freq_hz;
	}
	divident = (diff * pre_scaler *
		(ambarella_rct_pll_table[middle].sout + 1) *
		ambarella_rct_pll_table[middle].post);
	divident = divident << 32;
	divider = ((u64)ambarella_clk_ref_freq *
		(ambarella_rct_pll_table[middle].sdiv + 1));
	AMBCLK_DO_DIV_ROUND(divident, divider);
	if (freq_hz_int <= freq_hz) {
		frac_reg.s.nega	= 0;
		frac_reg.s.frac	= divident;
	} else {
		frac_reg.s.nega	= 1;
		frac_reg.s.frac	= 0x80000000 - divident;
	}
	pr_info("frac_reg = [0x%08X]\n", frac_reg.w);

	if (diff) {
		ctrl_reg.s.frac_mode = 1;
	} else {
		ctrl_reg.s.frac_mode = 0;
	}
	ctrl_reg.s.force_lock = 1;
	ctrl_reg.s.write_enable	= 0;
	pr_info("ctrl_reg = [0x%08X]\n", ctrl_reg.w);

	if (ctrl_reg.s.frac_mode) {
		ctrl2 = 0x3f770000;
		ctrl3 = 0x00069300;
	} else {
		ctrl2 = 0x3f770000;
		ctrl3 = 0x00068300;
	}
	pr_info("ctrl2_reg = [0x%08X]\n", ctrl2);
	pr_info("ctrl3_reg = [0x%08X]\n", ctrl3);

	ret_val = count;

ambarella_clock_proc_write_exit:
	return ret_val;
}

static int ambarella_clock_proc_open(struct inode *inode, struct file *file)
{
	return single_open(file, ambarella_clock_proc_show, PDE_DATA(inode));
}

static const struct file_operations proc_clock_fops = {
	.open = ambarella_clock_proc_open,
	.read = seq_read,
	.llseek = seq_lseek,
	.write = ambarella_clock_proc_write,
};
#endif

/* ==========================================================================*/
int __init ambarella_clk_init(unsigned int ref_freq)
{
	int ret_val = 0;

	ambarella_clk_ref_freq = ref_freq;
#if defined(CONFIG_AMBARELLA_PLL_PROC)
	proc_create_data("clock", S_IRUGO, get_ambarella_proc_dir(),
		&proc_clock_fops, NULL);
#endif

	return ret_val;
}

/* ==========================================================================*/
unsigned int ambarella_clk_get_ref_freq(void)
{
	return ambarella_clk_ref_freq;
}
EXPORT_SYMBOL(ambarella_clk_get_ref_freq);

